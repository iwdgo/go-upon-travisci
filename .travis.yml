language: go

arch: amd64

os:
  # windows : Ok
  - linux
  # osx : cannot remove IPv4

go: 1.14.x

env:
  - GO111MODULE=auto

install:
  - echo $TRAVIS_BUILD_DIR

before_script:
  - export GOROOT_BOOTSTRAP=$(go env GOROOT)
  - mkdir golang
  - cd golang
  - git clone --branch master --single-branch --no-tags https://github.com/golang/go.git
  - cd go
  - export GOCLONE=$(pwd)
  - cd $TRAVIS_BUILD_DIR
  - mv make_travisci.bash $GOCLONE/src/make.bash
  - export COMMIT_TITLE=$(basename -s .patch *.patch)
  - mv *.patch $GOCLONE
  - cd $GOCLONE
  - git log -1  --pretty=short # on tip
  # git has no global config on Travis CI. No '/home/travis/.gitconfig'
  - git config -l # displays local configuration
  - git config user.email "constantinkonstantinidis@gmail.com"
  - git config user.name "Constantin Konstantinidis"
  - git add -A
  - git commit -m "$COMMIT_TITLE"

script:
  - cd $GOCLONE/src
  - sh ./make.bash

after_success:
  - rm -f ./cmd/dist/dist
  - cd $GOCLONE
  - export GOROOT= # get intermediate commit of go
  - ./bin/go tool dist version
  - ./bin/go tool dist test

after_script:
  # Disable IPv4 and run net package tests
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then powershell Get-NetAdapterBinding -ComponentID "ms_tcpip6" -IncludeHidden ; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then powershell Set-NetAdapterBinding -ComponentID "ms_tcpip" -Enabled 0 -Name * -IncludeHidden ; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then ping locahost ; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sysctl --system --pattern '^net.ip.*' ; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sysctl -w net.ipv4.conf.all.disable_ipv4=1 ; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sysctl -w net.ipv4.conf.default.disable_ipv4=1 ; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ping -c 4 localhost ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then networksetup -listnetworkserviceorder ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then networksetup -setv4off * ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then networksetup -setv4off Ethernet; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then ping -c 4 localhost ; fi
  - ./bin/go tool dist test -run="net"
